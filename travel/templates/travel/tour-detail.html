{% extends 'travel/base.html' %}

{% block title %}Детали тура{% endblock %}

{% block content %}
<style>
    .card-text, .description {
        word-wrap: break-word; /* Перенос длинных слов */
        word-break: break-word; /* Для длинных слов без пробелов */
        white-space: normal; /* Убедимся, что текст переносится */
    }
</style>

<div class="container py-5">
    <h1 class="mb-4">{{ tour.name_tour }}</h1>
    <div class="row">
        <div class="col-md-6">
            {% if tour.image %}
            <img src="{{ tour.image.url }}" class="img-fluid rounded" alt="{{ tour.name_tour }}">
            {% else %}
            <img src="https://via.placeholder.com/600x400" class="img-fluid rounded" alt="Изображение недоступно">
            {% endif %}
        </div>
        <div class="col-md-6">
            <h3>Цена: {{ tour.price_tour }} ₽</h3>
            <p class="description">{{ tour.discription_tour }}</p>
            <p><strong>Место отправления:</strong> {{ tour.departure }}</p>
            <p><strong>Место назначения:</strong> {{ tour.destination }}</p>
            <p><strong>Дата отправления:</strong> {{ tour.date_departure|date:"d.m.Y" }}</p>
            <p><strong>Дата возвращения:</strong> {{ tour.date_return|date:"d.m.Y" }}</p>
            <p><strong>Доступные места:</strong> {{ tour.places_tour }}</p>
            <p>
                <strong>Видеообзор тура:</strong>
                {% if tour.video_url %}
                    <a href="{{ tour.video_url }}" target="_blank" rel="noopener noreferrer">Ссылка на обзор</a>
                {% else %}
                    Видеообзор недоступен
                {% endif %}
            </p>
            <form action="/reserve/" method="post">
                {% csrf_token %}
                <input type="hidden" name="tour_id" value="{{ tour.id }}">
                <button type="button" class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#reserveModal">
                    Забронировать
                </button>
            </form>
        </div>
    </div>
</div>
<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Последние отзывы</h2>
        <a href="{% url 'all_reviews' tour.id %}" class="btn btn-outline-primary">Все отзывы</a>
    </div>
    
    {% if latest_reviews %}
        <ul class="list-group">
            {% for review in latest_reviews %}
                <li class="list-group-item">
                    <h5>{{ review.id_user.name_user }}</h5>
                    <p class="mb-1">{{ review.text_review }}</p>
                    <small class="text-muted">Дата: {{ review.created_at|date:"d.m.Y H:i" }}</small>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p>Отзывов пока нет. Будьте первым, кто оставит отзыв!</p>
    {% endif %}
</div>
<!-- Модальное окно -->
<div class="modal fade" id="reserveModal" tabindex="-1" aria-labelledby="reserveModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="reserveForm" action="{% url 'reserve_tour' %}" method="post">
                {% csrf_token %}
                <input type="hidden" name="tour_id" value="{{ tour.id }}">
                <div class="modal-body">
                    <p><strong>Название тура:</strong> {{ tour.name_tour }}</p>
                    <p><strong>Дата отправления:</strong> {{ tour.date_departure|date:"d.m.Y" }}</p>
                    <p><strong>Дата возвращения:</strong> {{ tour.date_return|date:"d.m.Y" }}</p>
                    <p><strong>Цена:</strong> €{{ tour.price_tour }}</p>
                    <div class="mb-3">
                        <label for="paymentMethod" class="form-label">Способ оплаты</label>
                        <select name="payment_method" id="paymentMethod" class="form-select" required>
                            <option value="CARD">Банковская карта</option>
                            <option value="CASH">Наличные</option>
                            <option value="ONLINE">Онлайн оплата (СБП)</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Забронировать</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- Модальное окно успешного бронирования -->
<div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="successModalLabel">Успешное бронирование</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
            </div>
            <div class="modal-body">
                <p id="successMessage">Тур успешно забронирован!</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const reserveForm = document.getElementById('reserveForm');
        
        if (reserveForm) {
            reserveForm.addEventListener('submit', async function (event) {
                event.preventDefault();
    
                const submitButton = reserveForm.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                submitButton.textContent = 'Обработка...';
    
                const formData = new FormData(reserveForm);
    
                try {
                    const response = await fetch(reserveForm.action, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': reserveForm.querySelector('[name=csrfmiddlewaretoken]').value
                        }
                    });
    
                    // Обрабатываем редирект
                    if (response.redirected) {
                        window.location.href = response.url; // Переход на целевую страницу
                    } else {
                        const result = await response.json();
                        if (response.ok) {
                            alert(result.message || "Тур успешно забронирован!");
                        } else {
                            alert(result.error || "Ошибка бронирования.");
                        }
                    }
                } catch (error) {
                    console.error("Ошибка при отправке данных:", error);
                    alert("Произошла ошибка. Попробуйте снова.");
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = 'Забронировать';
                }
            });
        } else {
            console.error("Форма бронирования не найдена!");
        }
    });
</script>
{% endblock %}